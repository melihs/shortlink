version: '2.4'

services:

  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000

  kafka:
    # "`-._,-'"`-._,-'"`-._,-'"`-._,-'"`-._,-'"`-._,-'"`-._,-'"`-._,-'"`-._,-
    # An important note about accessing Kafka from clients on other machines:
    # -----------------------------------------------------------------------
    #
    # The config used here exposes port 9092 for _external_ connections to the broker
    # i.e. those from _outside_ the docker network. This could be from the host machine
    # running docker, or maybe further afield if you've got a more complicated setup.
    # If the latter is true, you will need to change the value 'localhost' in
    # KAFKA_ADVERTISED_LISTENERS to one that is resolvable to the docker host from those
    # remote clients
    #
    # For connections _internal_ to the docker network, such as from other services
    # and components, use kafka:29092.
    #
    # See https://rmoff.net/2018/08/02/kafka-listeners-explained/ for details
    # "`-._,-'"`-._,-'"`-._,-'"`-._,-'"`-._,-'"`-._,-'"`-._,-'"`-._,-'"`-._,-
    #
    image: confluentinc/cp-kafka:latest
    restart: on-failure
    container_name: kafka
    ports:
      - 9092:9092
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  lenses:
    image: lensesio/lenses
    environment:
      LENSES_PORT: 9991
      LENSES_KAFKA_BROKERS: "PLAINTEXT://kafka:9092"

      # # If you have enabled JMX for your brokers, set the port here
      # LENSES_KAFKA_METRICS_DEFAULT_PORT: 9581

      # # If you use AVRO, configure the Schema Registry
      # LENSES_SCHEMA_REGISTRY_URLS: |
      #   [
      #     {url:"http://schema.registry.1.url:8081"},
      #     {url:"http://schema.registry.2.url:8081"}
      #   ]

      # # If you use Kafka Connect, configure the workers.
      # LENSES_KAFKA_CONNECT_CLUSTERS: |
      #   [
      #     {
      #       name:"data_science",
      #       urls: [
      #         {url:"http://connect.worker.1.url:8083"},
      #         {url:"http://connect.worker.2.url:8083"}
      #       ],
      #       statuses:"connect-statuses-cluster-a",
      #       configs:"connect-configs-cluster-a",
      #       offsets:"connect-offsets-cluster-a"
      #     }
      #   ]

      # Zookeeper access is optional
      LENSES_ZOOKEEPER_HOSTS: |
        [
         {url:"zookeeper:2181"}
        ]

      # # Users are managed within Lenses. Here you can change the superuser username:
      LENSES_SECURITY_USER: admin
      # # Users are managed within Lenses. Here you can change the superuser password:
      LENSES_SECURITY_PASSWORD: admin
    ports:
      - 9991:9991
      - 9102:9102
    volumes:
      - ./ops/docker-compose/mq/license.json:/license.json
    network_mode: host
