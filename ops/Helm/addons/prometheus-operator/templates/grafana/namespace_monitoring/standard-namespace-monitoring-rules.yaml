# Link: https://github.com/onzack/grafana-dashboards/blob/main/prometheus/recording-rules/onzack-namespace-monitoring-recording-rules.yaml

apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: standard-namespace-monitoring-recording-rules
spec:
  groups:
    - name: cpu
      rules:
        - record: container_cpu_usage_seconds_total:sum_rate5m
          expr: |-
            sum by (container,pod,namespace,node,role) (
              rate(container_cpu_usage_seconds_total{container!="", container!="POD"}[5m]) * on(pod, namespace) group_left() (kube_pod_status_phase{phase="Running"}==1) * on(node) group_left(role) instance:kube_node_role
            )
        - record: kube_pod_container_resource_requests:cpu:running
          expr: |-
            sum by (container,pod,namespace,node,role) (
              kube_pod_container_resource_requests{resource="cpu"} * on(pod, namespace) group_left() (kube_pod_status_phase{phase="Running"}==1) * on(node) group_left(role) instance:kube_node_role
            )
        - record: kube_pod_container_resource_limits:cpu:running
          expr: |-
            sum by (container,pod,namespace,node,role) (
              kube_pod_container_resource_limits{resource="cpu"} * on(pod, namespace) group_left() (kube_pod_status_phase{phase="Running"}==1) * on(node) group_left(role) instance:kube_node_role
            )
        - record: container_cpu_cfs_throttling:percent
          expr: |-
            100
            /
            sum by (container,pod,namespace,node,role) (
              increase(container_cpu_cfs_periods_total{container!="", container!="POD"}[5m]) * on(pod, namespace) group_left() (kube_pod_status_phase{phase="Running"}==1) * on(node) group_left(role) instance:kube_node_role
            )
            *
            sum by (container,pod,namespace,node,role) (
              increase(container_cpu_cfs_throttled_periods_total{container!="", container!="POD"}[5m]) * on(pod, namespace) group_left() (kube_pod_status_phase{phase="Running"}==1) * on(node) group_left(role) instance:kube_node_role
            )
    - name: memory
      rules:
        - record: container_memory_working_set_bytes:sum
          expr: |-
            sum by (container,pod,namespace,node,role) (
              container_memory_working_set_bytes{container!="", container!="POD"} * on(pod, namespace) group_left() (kube_pod_status_phase{phase="Running"}==1) * on(node) group_left(role) instance:kube_node_role
            )
        - record: kube_pod_container_resource_requests:memory:running
          expr: |-
            sum by (container,pod,namespace,node,role) (
              kube_pod_container_resource_requests{resource="memory"} * on(pod, namespace) group_left() (kube_pod_status_phase{phase="Running"}==1) * on(node) group_left(role) instance:kube_node_role
            )
        - record: kube_pod_container_resource_limits:memory:running
          expr: |-
            sum by (container,pod,namespace,node,role) (
              kube_pod_container_resource_limits{resource="memory"} * on(pod, namespace) group_left() (kube_pod_status_phase{phase="Running"}==1) * on(node) group_left(role) instance:kube_node_role
            )
    - name: storage
      rules:
        - record: container_fs_reads_bytes_total:sum_rate5m
          expr: |-
            sum by (container,pod,namespace,node,role) (
              rate(container_fs_reads_bytes_total{container!="", container!="POD"}[5m]) * on(pod, namespace) group_left() (kube_pod_status_phase{phase="Running"}==1) * on(node) group_left(role) instance:kube_node_role
            )
        - record: container_fs_reads_total:sum_rate5m
          expr: |-
            sum by (container,pod,namespace,node,role) (
              rate(container_fs_reads_total{container!="", container!="POD"}[5m]) * on(pod, namespace) group_left() (kube_pod_status_phase{phase="Running"}==1) * on(node) group_left(role) instance:kube_node_role
            )
        - record: container_fs_writes_bytes_total:sum_rate5m
          expr: |-
            sum by (container,pod,namespace,node,role) (
              rate(container_fs_writes_bytes_total{container!="", container!="POD"}[5m]) * on(pod, namespace) group_left() (kube_pod_status_phase{phase="Running"}==1) * on(node) group_left(role) instance:kube_node_role
            )
        - record: container_fs_writes_total:sum_rate5m
          expr: |-
            sum by (container,pod,namespace,node,role) (
              rate(container_fs_writes_total{container!="", container!="POD"}[5m]) * on(pod, namespace) group_left() (kube_pod_status_phase{phase="Running"}==1) * on(node) group_left(role) instance:kube_node_role
            )
    - name: network
      rules:
        - record: container_network_receive_bytes_total:sum_rate5m
          expr: |-
            sum by (pod,namespace,node,role) (
              rate(container_network_receive_bytes_total[5m]) * on(pod, namespace) group_left() (kube_pod_status_phase{phase="Running"}==1) * on(node) group_left(role) instance:kube_node_role
            )
        - record: container_network_receive_packets_total:sum_rate5m
          expr: |-
            sum by (pod,namespace,node,role) (
              rate(container_network_receive_packets_total[5m]) * on(pod, namespace) group_left() (kube_pod_status_phase{phase="Running"}==1) * on(node) group_left(role) instance:kube_node_role
            )
        - record: container_network_receive_packets_dropped_total:sum_rate5m
          expr: |-
            sum by (pod,namespace,node,role) (
              rate(container_network_receive_packets_dropped_total[5m]) * on(pod, namespace) group_left() (kube_pod_status_phase{phase="Running"}==1) * on(node) group_left(role) instance:kube_node_role
            )
        - record: container_network_transmit_bytes_total:sum_rate5m
          expr: |-
            sum by (pod,namespace,node,role) (
              rate(container_network_transmit_bytes_total[5m]) * on(pod, namespace) group_left() (kube_pod_status_phase{phase="Running"}==1) * on(node) group_left(role) instance:kube_node_role
            )
        - record: container_network_transmit_packets_total:sum_rate5m
          expr: |-
            sum by (pod,namespace,node,role) (
              rate(container_network_transmit_packets_total[5m]) * on(pod, namespace) group_left() (kube_pod_status_phase{phase="Running"}==1) * on(node) group_left(role) instance:kube_node_role
            )
        - record: container_network_transmit_packets_dropped_total:sum_rate5m
          expr: |-
            sum by (pod,namespace,node,role) (
              rate(container_network_transmit_packets_dropped_total[5m]) * on(pod, namespace) group_left() (kube_pod_status_phase{phase="Running"}==1) * on(node) group_left(role) instance:kube_node_role
            )
