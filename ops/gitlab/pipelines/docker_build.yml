include:
  - local: /ops/gitlab/workflows/matrix_build_go.yml
  - local: /ops/gitlab/templates/common.yml
  - local: /ops/gitlab/templates/go_build.yml
# TODO: fix container scanning
#  - template: Container-Scanning.gitlab-ci.yml

stages:
  - build
  - security

# DEPENDENCY ===========================================================================================================
dependencies_go:
  extends:
    - .job_template_build_go
  stages: .pre
  variables:
    REGISTRY_IMAGE: $CI_REGISTRY_IMAGE/dependencies_go
    DOCKERFILE_PATH: ops/dockerfile/dependencies/go.Dockerfile

dependencies_nodejs:
  extends:
    - .job_template_build_nodejs
  stages: .pre
  variables:
    REGISTRY_IMAGE: $CI_REGISTRY_IMAGE/dependencies_nodejs
    DOCKERFILE_PATH: ops/dockerfile/dependencies/nodejs.Dockerfile


# BUILD ================================================================================================================
go:
  extends:
    - .job_template_build_go
    - .matrix_build_go

nodejs:
  extends:
    - .job_template_build_nodejs
    - .matrix_build_nodejs

# SECURITY =============================================================================================================
# Read more about this feature here: https://docs.gitlab.com/ee/user/application_security/container_scanning/

#container_scanning:
#  extends:
#    - .matrix_build
#  stage: security
#  variables:
#    GIT_STRATEGY: fetch
#    CI_APPLICATION_REPOSITORY: $REGISTRY_IMAGE
#    CI_APPLICATION_TAG: $CI_COMMIT_TAG
#  allow_failure: false
#  rules:
#    - if: $CI_COMMIT_TAG
#      when: on_success
#    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
#      when: on_success
