include:
  - local: /ops/gitlab/pipelines/ui/templates/cache.yml

.nx:
  extends: .cache
  image: node:20.2-alpine
  interruptible: true
  variables:
    GIT_DEPTH: 0
    NEXT_PUBLIC_GOOGLE_ANALYTICS_ID: G-DBZDFPJCJ9
    NEXT_PUBLIC_CLOUDFLARE_SITE_KEY: 0x4AAAAAAAEzDnfy4idw0bBk
  before_script:
    - cd ui/nx-monorepo
    - |
      {
        echo "//${CI_SERVER_HOST}/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}"
        echo "@${CI_PROJECT_ROOT_NAMESPACE}/shortlink=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/npm/"
      } | tee -a ~/.npmrc
    - apk add --no-cache git || apt-get install -y git
    - npm ci --cache .npm --prefer-offline
    - NX_HEAD=$CI_COMMIT_SHA
    - NX_BASE=${CI_MERGE_REQUEST_DIFF_BASE_SHA:-$CI_COMMIT_BEFORE_SHA}
