include:
  - local: /ops/gitlab/templates/common.yml
  # TODO: include:local with wildcard file paths
  # https://docs.gitlab.com/ee/ci/yaml/README.html#includelocal-with-wildcard-file-paths
  - local: /ops/gitlab/pipelines/addons/network.yml
  - local: /ops/gitlab/pipelines/addons/k8s.yml
  - local: /ops/gitlab/pipelines/addons/database.yml
  - local: /ops/gitlab/pipelines/addons/monitoring.yml
  - local: /ops/gitlab/pipelines/addons/mq.yml

stages:
  - .pre
  - monitoring
  - gateway
  - deploy
  - database
  - mq
  - .post

# Set secret credential
dockerfile:
  extends:
    - .matrix_deploy_provider
  stage: .pre
  services:
    - name: docker:dind
      command: [ "--experimental" ]
  image: docker:latest
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - apk add curl
  script:
    - curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
    - chmod +x kubectl
    - ./kubectl create secret generic regcred 
      --context=shortlink-org/shortlink:${PROVIDER}
      --from-file=.dockerconfigjson=/root/.docker/config.json 
      --type=kubernetes.io/dockerconfigjson
  when: manual
