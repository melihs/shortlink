include:
  - local: /ops/gitlab/workflows/matrix_deploy.yml

# Deploy ===============================================================================================================
prometheus-operator:
  stage: deploy
  variables:
    RELEASE_NAME: prometheus-operator
    HELM_PATH: ops/Helm/addons/prometheus-operator
    HELM_NAMESPACE: prometheus-operator
    HELM_ARG: --set kube-prometheus-stack.alertmanager.config.global.slack_api_url=$SLACK_TOKEN
    ENVIRONMENT_URL: $ENVIRONMENT_URL/prometheus
  trigger:
    include:
      - local: 'ops/gitlab/pipelines/helm_deploy.yml'
    strategy: depend
  needs: [ ]
  rules:
    - when: manual

argo:
  stage: deploy
  variables:
    RELEASE_NAME:
      value: argocd
      options:
        - argocd
        - argo-shortlink
    HELM_PATH: ops/Helm/addons/$RELEASE_NAME
    HELM_NAMESPACE: argocd
    ENVIRONMENT_URL: $ENVIRONMENT_URL/$RELEASE_NAME
  trigger:
    include:
      - local: 'ops/gitlab/pipelines/helm_deploy.yml'
    strategy: depend
  needs: [ ]
  rules:
    - when: manual

argo-secret:
  extends:
    - .matrix_deploy_provider
  stage: deploy
  image:
    name: alpine/k8s:1.25.0
    entrypoint: [ "" ]
  before_script:
    - kubectl delete secret
      --context=shortlink-org/shortlink:${PROVIDER}
      --namespace=argocd
      sops-gpg || true
  script:
    - kubectl create secret generic
      --context=shortlink-org/shortlink:${PROVIDER}
      --namespace=argocd 
      --from-file=sops.asc=${GPG_TOKEN}
      sops-gpg
  needs: []
  rules:
    - when: manual

addons:
  stage: deploy
  variables:
    RELEASE_NAME:
      value: service
      options:
        - keda
        - flagger
    HELM_PATH: ops/Helm/addons/$RELEASE_NAME
    HELM_NAMESPACE: $RELEASE_NAME
    ENVIRONMENT_URL: $ENVIRONMENT_URL/$RELEASE_NAME
  trigger:
    include:
      - local: 'ops/gitlab/pipelines/helm_deploy.yml'
    strategy: depend
  needs: []
  rules:
    - when: manual

