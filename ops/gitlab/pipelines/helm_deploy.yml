include:
  - local: /ops/gitlab/templates/common.yml
  - local: /ops/gitlab/templates/deploy.yml
  - local: /ops/gitlab/templates/drop.yml
  - local: /ops/gitlab/workflows/matrix_deploy.yml

stages:
  - deploy
  - action

deploy:
  extends:
    - .job_template_deploy
    - .matrix_deploy
  tags:
    - docker
  environment:
    name: ${PROVIDER}/${RELEASE_NAME}
    url: $ENVIRONMENT_URL
    on_stop: drop
    kubernetes:
      namespace: ${HELM_NAMESPACE}

rollback:
  extends:
    - .job_template_drop
  script:
    - env
    - helm --namespace=$KUBE_NAMESPACE rollback $RELEASE_NAME 0
  needs:
    - deploy
  when: manual

drop:
  extends:
    - .job_template_drop
  tags:
    - docker
  environment:
    name: ${PROVIDER}/${RELEASE_NAME}
    action: stop
