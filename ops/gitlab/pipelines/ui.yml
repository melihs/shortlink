#include:
#  - local: /ops/gitlab/pipelines/helm_deploy.yml
#  - local: /ops/gitlab/stages/accessibility.yml

stages:
#  - test
  - build
  - docker
#  - deploy
#  - accessibility
#  - action

.distributed:
  image: node:20.0-alpine
  interruptible: true
  variables:
    GIT_DEPTH: 0
  cache:
    key: nx-${CI_COMMIT_REF_SLUG}
    paths:
      - .npm/
      - packages/landing/out
  artifacts:
    paths:
      - packages/landing/out
  before_script:
    - cd ui/nx-monorepo
    - apk add --no-cache git
    - npm ci --cache .npm --prefer-offline
    - NX_HEAD=$CI_COMMIT_SHA
    - NX_BASE=${CI_MERGE_REQUEST_DIFF_BASE_SHA:-$CI_COMMIT_BEFORE_SHA}

#format-check:
#  stage: test
#  extends: .distributed
#  script:
#    - npx nx format:check --base=$NX_BASE --head=$NX_HEAD
#
#lint:
#  stage: test
#  extends: .distributed
#  script:
#    - npx nx affected --base=$NX_BASE --head=$NX_HEAD -t lint --parallel=3

build:
  stage: build
  extends: .distributed
  script:
    - npm run build
    - npx nx export landing
    - ls -la packages/landing

docker:
  stage: docker
  variables:
    APPLICATION: ${APPLICATION}
    REGISTRY_IMAGE: ${REGISTRY_IMAGE}
    DOCKERFILE_PATH: ${DOCKERFILE_PATH}
    DOCKERFILE_ARGS: ${DOCKERFILE_ARGS}
    CACHE_KEY: nx-${CI_COMMIT_REF_SLUG}
    CACHE_PATH: ui/nx-monorepo/packages/landing/out
    CI_COMMIT_TAG: test # DELETE THIS LINE
  trigger:
    include:
      - local: 'ops/gitlab/pipelines/build/docker_base.yml'
    strategy: depend
