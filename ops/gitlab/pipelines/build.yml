include:
  - local: /ops/gitlab/workflows/matrix_build.yml
  - local: /ops/gitlab/templates/common.yml
  - local: /ops/gitlab/templates/build.yml
  - template: Container-Scanning.gitlab-ci.yml

stages:
  - build
  - security

# BUILD ================================================================================================================
build:
  extends:
    - .job_template_build
    - .matrix_build

# SECURITY =============================================================================================================
container_scanning:
  extends:
    - .matrix_build
  stage: security
  variables:
    GIT_STRATEGY: fetch
    CI_APPLICATION_REPOSITORY: $REGISTRY_IMAGE
    CI_APPLICATION_TAG: $CI_COMMIT_TAG
  allow_failure: false
  rules:
    - if: $CI_COMMIT_TAG
      when: on_success
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: on_success
