include:
  # https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Jobs/Secret-Detection.gitlab-ci.yml
  - template: Jobs/Secret-Detection.gitlab-ci.yml

stages:
  - test
  - approve

# SECRET-DETECTION =====================================================================================================
# Read more about this feature here: https://docs.gitlab.com/ee/user/application_security/secret_detection
#
# Configure the scanning tool through the environment variables.
# List of the variables: https://gitlab.com/gitlab-org/security-products/secret_detection#available-variables
# How to set: https://docs.gitlab.com/ee/ci/yaml/#variables
secret_detection:
  stage: test
  needs: []
  artifacts:
    paths:
      - gl-secret-detection-report.json
  rules:
    - when: on_success

process_secret_detection:
  image: python:3.11-alpine
  stage: approve
  needs:
    - job: secret_detection
      artifacts: true
  before_script:
    - pip install python-gitlab
  script:
    - python3 ./ops/gitlab/scripts/approve/process_vulns.py gl-secret-detection-report.json $GITLAB_TOKEN $CI_PROJECT_ID $CI_COMMIT_SHA
  rules:
    - when: always
