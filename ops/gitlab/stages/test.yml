include:
  - template: Jobs/Dependency-Scanning.gitlab-ci.yml
  # https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Jobs/License-Scanning.gitlab-ci.yml
  - template: Jobs/License-Scanning.gitlab-ci.yml
  # https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Jobs/Code-Quality.gitlab-ci.yml
  - template: Jobs/Code-Quality.gitlab-ci.yml
  - local: /ops/gitlab/templates/rules.yml

# GOLANG ===============================================================================================================
GOLANG:
  extends: .rules_tag
  stage: test
  trigger:
    include:
      - local: 'ops/gitlab/pipelines/test/golang.yml'
    strategy: depend
  needs: []
  rules:

# HELM =================================================================================================================
HELM:
  extends: .rules_tag
  stage: test
  trigger:
    include:
      - local: 'ops/gitlab/pipelines/test/helm.yml'
    strategy: depend
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - changes:
        - ops/Helm/*/*
    - if: $CI_COMMIT_TAG
      when: on_success

# LICENSE ==============================================================================================================
# Read more about this feature here: https://docs.gitlab.com/ee/user/application_security/license_compliance/
license_scanning:
  extends: .rules_tag
  interruptible: true

# SECRET-DETECTION =====================================================================================================
secret_detection:
  extends: .rules_tag
  stage: test
  trigger:
    include:
      - local: 'ops/gitlab/pipelines/test/secret.yml'
    strategy: depend

# SAST =================================================================================================================
SAST:
  extends: .rules_tag
  stage: test
  trigger:
    include:
      - local: 'ops/gitlab/pipelines/test/sast.yml'
    strategy: depend

# CODE QUALITY =========================================================================================================
code_quality:
  extends: .rules_tag

code_quality_html:
  extends: code_quality
  variables:
    REPORT_FORMAT: html

# DEPENDENCY ===========================================================================================================
# Read more about this feature here: https://docs.gitlab.com/ee/user/application_security/dependency_scanning/
#
# Configure dependency scanning with CI/CD variables (https://docs.gitlab.com/ee/ci/variables/index.html).
# List of available variables: https://docs.gitlab.com/ee/user/application_security/dependency_scanning/index.html#available-variables

gemnasium-dependency_scanning:
  rules:
    - when: $CI_COMMIT_TAG
      exists: !reference [.gemnasium-shared-rule, exists]

gemnasium-maven-dependency_scanning:
  rules:
    - when: $CI_COMMIT_TAG
      exists: !reference [.gemnasium-maven-shared-rule, exists]

gemnasium-python-dependency_scanning:
  rules:
    - when: $CI_COMMIT_TAG
      exists: !reference [.gemnasium-python-shared-rule, exists]
