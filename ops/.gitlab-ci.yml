.job_template_build: &job_build
  type: build
  except:
    - branches
  when: on_success
  retry: 2

.job_template_deploy: &job_deploy
  type: deploy
  variables:
    GIT_STRATEGY: none
  script:
    - helm --kube-context $KUBE_CONTEXT upgrade $RELEASE_NAME $HELM_PATH
      --install
      --force
      --wait
      --namespace=$PROJECT_NAMESPACE
      --set CI_PROJECT_NAME=$CI_PROJECT_NAME;
  except:
    - branches
  when: manual

services:
  - name: docker:19.03-dind
    alias: localhost # necessary for correct addressing to services running in docker

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: tcp://docker:2375
  PROJECT_NAMESPACE: shortlink
  a11y_urls: "https://about.gitlab.com" # https://docs.gitlab.com/ee/user/project/merge_requests/accessibility_testing.html#configure-accessibility-testing

include:
  - remote: "https://gitlab.com/gitlab-org/gitlab/-/raw/master/lib/gitlab/ci/templates/Verify/Accessibility.gitlab-ci.yml"

stages:
  - test
  - build
  - deploy
  - accessibility

# ON COMMIT ============================================================================================================
golint:
  type: test
  image: golangci/golangci-lint:v1.23.6
  script:
    - make golint

gosec:
  type: test
  image: golang:1.14-buster
  before_script:
    - go get -u github.com/securego/gosec/cmd/gosec
  script:
    - make gosec

gotest:
  type: test
  image: golang:1.14-buster
  script:
    - make test

# STAGING RELEASE ======================================================================================================

deploy:staging:
  <<: *job_deploy
  variables:
    KUBE_CONTEXT: production
    RELEASE_NAME: $CI_PROJECT_NAME
    HELM_PATH: ops/Helm/${CI_PROJECT_NAME}
  environment:
    name: Production
    url: stage.example.com
  only:
    - /^(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)-rc(?:0|[1-9]\d*)$/

# PRODUCTION RELEASE ===================================================================================================

deploy:production:
  <<: *job_deploy
  variables:
    KUBE_CONTEXT: production
    RELEASE_NAME: $CI_PROJECT_NAME
    HELM_PATH: ops/Helm/${CI_PROJECT_NAME}
  environment:
    name: Production
    url: prod.example.com
  only:
    - /^(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.?(?:0|[1-9]\d*)?$/
