apiVersion: authzed.com/v1alpha1
kind: SpiceDBCluster
metadata:
  name: shortlink
spec:
  config:
    replicas: 1
    datastoreEngine: postgres
  secretName: shortlink-spicedb-config
  patches:
    - kind: Deployment
      patch:
        spec:
          template:
            spec:
              containers:
                - name: spicedb
                  env:
                    - name: SPICEDB_DATASTORE_CONN_URI
                      valueFrom:
                        secretKeyRef:
                          name: spicedb-postgres-pguser-spicedb
                          key: uri
    - kind: Job
      patch:
        spec:
          template:
            spec:
              containers:
                - name: migrate
                  image: 'ghcr.io/authzed/spicedb:v1.22.0-rc8'
                  env:
                  - name: SPICEDB_DATASTORE_CONN_URI
                    valueFrom:
                      secretKeyRef:
                      name: spicedb-postgres-pguser-spicedb
                      key: uri
