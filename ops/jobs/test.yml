include:
  - local: /ops/jobs/templates/go.yml
  - template: License-Scanning.gitlab-ci.yml

# ON COMMIT ============================================================================================================
golint:
  extends:
    - .job_teplate_go
  image: golangci/golangci-lint:v1.24.0
  script:
    - make golint

gosec:
  extends:
    - .job_teplate_go
  before_script:
    - curl -sfL https://raw.githubusercontent.com/securego/gosec/master/install.sh | sh -s -- -b $GOPATH/bin v2.2.0
  script:
    - make gosec

gotest:
  extends:
    - .job_teplate_go
  script:
    - make test

# Read more about this feature here: https://docs.gitlab.com/ee/user/application_security/license_compliance/
license_scanning:
  only:
    refs:
      - branches
      - tags

helm-lint-chart:
  stage: test
  image: quay.io/helmpack/chart-testing
  script:
    - ct lint --all --config ct.yaml

helm-run-chart:
  stage: test
  image: quay.io/helmpack/chart-testing
  variables:
    KIND: v0.7.0
  before_script:
    - apk add -U docker
    - wget -O /usr/local/bin/kind https://github.com/kubernetes-sigs/kind/releases/download/${KIND}/kind-linux-amd64
    - chmod +x /usr/local/bin/kind
    - kind create cluster --wait 2m --config=./ops/Helm/kind-config.yaml
    - sed -i -E -e 's/localhost|0\.0\.0\.0/docker/g' "$HOME/.kube/config"
  script:
    - ct install --config ct.yaml
