include:
  - local: /ops/jobs/templates/deploy.yml

# CUSTOM TEMPLATE ======================================================================================================
.job_template_deploy_staging: &job_deploy_staging
  extends:
    - .job_template_deploy
  environment:
    name: yandex-staging
    url: staging.example.com
  only:
    refs:
      - /^(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)-rc(?:0|[1-9]\d*)$/

.job_template_deploy_production: &job_deploy_production
  extends:
    - .job_template_deploy
  environment:
    name: yandex-production
    url: production.example.com
  only:
    refs:
      - /^(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.?(?:0|[1-9]\d*)?$/

# STAGING RELEASE ======================================================================================================

api:staging:
  extends:
    - .job_template_deploy_staging
  variables:
    ENVIRONMENT: yandex-staging
    RELEASE_NAME: $CI_PROJECT_NAME-api
    HELM_PATH: ops/Helm/${CI_PROJECT_NAME}-api
    REGISTRY: registry.gitlab.com/shortlink1/shortlink/api
  needs:
    - build:api

logger:staging:
  extends:
    - .job_template_deploy_staging
  variables:
    ENVIRONMENT: yandex-staging
    RELEASE_NAME: $CI_PROJECT_NAME-logger
    HELM_PATH: ops/Helm/${CI_PROJECT_NAME}-logger
    REGISTRY: registry.gitlab.com/shortlink1/shortlink/logger
  needs:
    - build:logger

ui:staging:
  extends:
    - .job_template_deploy_staging
  variables:
    ENVIRONMENT: yandex-staging
    RELEASE_NAME: $CI_PROJECT_NAME-ui
    HELM_PATH: ops/Helm/${CI_PROJECT_NAME}-ui
    REGISTRY: registry.gitlab.com/shortlink1/shortlink/ui-nuxt
  needs:
    - build:ui

# PRODUCTION RELEASE ===================================================================================================

api:production:
  extends:
    - .job_template_deploy_production
  variables:
    ENVIRONMENT: yandex-production
    RELEASE_NAME: $CI_PROJECT_NAME-api
    HELM_PATH: ops/Helm/${CI_PROJECT_NAME}-api
    REGISTRY: registry.gitlab.com/shortlink1/shortlink/api
  needs:
    - build:api

logger:production:
  extends:
    - .job_template_deploy_production
  variables:
    ENVIRONMENT: yandex-production
    RELEASE_NAME: $CI_PROJECT_NAME-logger
    HELM_PATH: ops/Helm/${CI_PROJECT_NAME}-logger
    REGISTRY: registry.gitlab.com/shortlink1/shortlink/logger
  needs:
    - build:logger

ui:production:
  extends:
    - .job_template_deploy_production
  variables:
    ENVIRONMENT: yandex-production
    RELEASE_NAME: $CI_PROJECT_NAME-ui
    HELM_PATH: ops/Helm/${CI_PROJECT_NAME}-ui
    REGISTRY: registry.gitlab.com/shortlink1/shortlink/ui-nuxt
  needs:
    - build:ui
