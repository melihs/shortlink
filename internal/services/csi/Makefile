SELF_DIR := $(dir $(lastword $(MAKEFILE_LIST)))

# INCLUDE ==============================================================================================================
# Include Makefile
include $(SELF_DIR)/../../../ops/Makefile/common.mk

# CSI TASKS ============================================================================================================

# Change to the latest supported snapshotter version
SNAPSHOTTER_VERSION=v6.2.1

build: ## Build the CSI container
		@echo docker buildx build \
			--platform=linux/amd64 \
			--provenance=true \
			--sbom=true \
			image ${CI_REGISTRY_IMAGE}-csi:${CI_COMMIT_TAG}
		@docker buildx build \
			--platform=linux/amd64 \
			--provenance=true \
			--sbom=true \
			--no-cache \
			-t ${CI_REGISTRY_IMAGE}-csi \
			-f ops/dockerfile/csi.Dockerfile .

up: ## Deploy CSI plugin
		# Apply VolumeSnapshot CRDs
		@kubectl apply -f "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/${SNAPSHOTTER_VERSION}/client/config/crd/snapshot.storage.k8s.io_volumesnapshotclasses.yaml"
		@kubectl apply -f "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/${SNAPSHOTTER_VERSION}/client/config/crd/snapshot.storage.k8s.io_volumesnapshotcontents.yaml"
		@kubectl apply -f "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/${SNAPSHOTTER_VERSION}/client/config/crd/snapshot.storage.k8s.io_volumesnapshots.yaml"

		# Create snapshot controller
		@kubectl apply -f "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/${SNAPSHOTTER_VERSION}/deploy/kubernetes/snapshot-controller/rbac-snapshot-controller.yaml"
		@kubectl apply -f "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/${SNAPSHOTTER_VERSION}/deploy/kubernetes/snapshot-controller/setup-snapshot-controller.yaml"

		# applying RBAC rules
		@kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-provisioner/v2.0.3/deploy/kubernetes/rbac.yaml
		@kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-attacher/v3.0.1/deploy/kubernetes/rbac.yaml
		@kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v3.0.1/deploy/kubernetes/csi-snapshotter/rbac-csi-snapshotter.yaml
		@kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-resizer/v1.0.1/deploy/kubernetes/rbac.yaml

		@kubectl apply -f /home/batazor/myproejct/shortlink/ops/Helm/csi/templates/

example: ## Deploy examples for CSI
	@kubectl apply -f ops/Helm/csi/examples/
